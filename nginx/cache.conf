# Cache configuration for improved performance
# Include this file to enable caching

# Cache zones definition
proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m use_temp_path=off;
proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=static_cache:10m max_size=500m inactive=24h use_temp_path=off;

# Cache key configuration
proxy_cache_key "$scheme$request_method$host$request_uri";

# Cache bypass conditions
set $skip_cache 0;

# Skip cache for authenticated users
if ($http_authorization) {
    set $skip_cache 1;
}

# Skip cache for POST requests
if ($request_method = POST) {
    set $skip_cache 1;
}

# Skip cache for URLs with query parameters (except static assets)
if ($query_string != "") {
    set $skip_cache 1;
}

# Cache configuration for API responses
location ~* ^/(auth|aceas/api|cpds/api|ids)/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 302 5m;
    proxy_cache_valid 404 1m;
    proxy_cache_bypass $skip_cache;
    proxy_no_cache $skip_cache;
    
    # Add cache status header for debugging
    add_header X-Cache-Status $upstream_cache_status;
    
    # Include proxy settings
    include /etc/nginx/proxy.conf;
}

# Cache configuration for static assets
location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip)$ {
    proxy_cache static_cache;
    proxy_cache_valid 200 24h;
    proxy_cache_valid 404 5m;
    
    # Long-term browser caching
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Cache-Status $upstream_cache_status;
    
    # Include proxy settings
    include /etc/nginx/proxy.conf;
}