# Vite-specific cache configuration for optimal cache busting
# Include this file to enable Vite-optimized caching strategy

# Cache hashed assets aggressively (Vite pattern)
location ~* ^/assets/.+-[a-zA-Z0-9_-]+\.(css|js|woff|woff2|ttf|eot|png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
    # These are Vite-generated hashed files - safe to cache forever
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Vite-Cache "hashed-asset";
    add_header Vary "Accept-Encoding";
    
    # Enable gzip_static for all hashed assets
    gzip_static on;
    # brotli_static on;  # Enable if brotli module is available
}

# Short cache for non-hashed assets (development/fallback)
location ~* ^/assets/.*\.(css|js|woff|woff2|ttf|eot|png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
    add_header X-Vite-Cache "non-hashed-asset";
    add_header Vary "Accept-Encoding";
}

# HTML files - aggressive no-cache for fresh builds
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate";
    add_header Pragma "no-cache";
    add_header X-Vite-Cache "html-fresh";
    
    # Add ETag based on file modification time
    etag on;
    if_modified_since exact;
}

# Vite's special files - no cache
location ~* \.(map|manifest\.json|vite\.config\..*)$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header X-Vite-Cache "dev-file";
}

# PWA/Service Worker files - no cache
location ~* \.(sw\.js|workbox-.+\.js|manifest\.webmanifest)$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header X-Vite-Cache "pwa-file";
}