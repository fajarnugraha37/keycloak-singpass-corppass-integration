{"version":3,"file":"index-DoZgVH7v-mgwgoinm.js","sources":["../../../web/src/pages/aceas.js"],"sourcesContent":["import 'htmx.org';\r\nimport './common.js';\r\nimport { signal, effect } from \"@preact/signals\";\r\nimport { callApi, log, showLoading, hideLoading } from \"../shared/index.js\";\r\nimport { oidc } from \"./oidc.js\";\r\n\r\n// DOM elements\r\nconst loginBtn = document.getElementById(\"login\");\r\nconst logoutBtn = document.getElementById(\"logout\");\r\nconst userInfoBtn = document.getElementById(\"userinfo\");\r\nconst callApiBtn = document.getElementById(\"callapi\");\r\nconst switchBtn = document.getElementById(\"switch\");\r\nconst authStatus = document.getElementById(\"auth-status\");\r\nconst clearConsoleBtn = document.getElementById(\"clear-console\");\r\n\r\n// State management\r\nconst state = {\r\n    isAuthenticated: signal(false),\r\n    isLoading: signal(false),\r\n    userInfo: signal(null),\r\n};\r\n\r\n// Enhanced logging with timestamps and styling\r\nfunction enhancedLog(message, type = 'info') {\r\n    const timestamp = new Date().toLocaleTimeString();\r\n    const prefix = `[${timestamp}] [${type.toUpperCase()}]`;\r\n    const styledMessage = `${prefix} ${message}`;\r\n    log(\"out\", styledMessage);\r\n    console.log(styledMessage);\r\n}\r\n\r\n// Clear console functionality\r\nfunction clearConsole() {\r\n    const consoleOutput = document.getElementById('out');\r\n    if (consoleOutput) {\r\n        consoleOutput.textContent = 'Console cleared.\\nWaiting for user interaction...';\r\n    }\r\n}\r\n\r\n// Update authentication status indicator\r\nfunction updateAuthStatus(isAuthenticated, userInfo = null) {\r\n    if (!authStatus) return;\r\n    \r\n    const statusDot = authStatus.querySelector('div');\r\n    const statusText = authStatus.querySelector('span');\r\n    \r\n    if (isAuthenticated) {\r\n        authStatus.className = 'status-indicator status-online';\r\n        if (statusDot) statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';\r\n        if (statusText) statusText.textContent = userInfo ? `${userInfo.preferred_username || 'User'}` : 'Authenticated';\r\n    } else {\r\n        authStatus.className = 'status-indicator status-offline';\r\n        if (statusDot) statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';\r\n        if (statusText) statusText.textContent = 'Not Authenticated';\r\n    }\r\n}\r\n\r\n// Enhanced loading states\r\nfunction setLoadingState(message) {\r\n    const loadingOverlay = document.getElementById('loading-overlay');\r\n    const loadingMessage = loadingOverlay?.querySelector('.loading-message');\r\n    if (loadingMessage) {\r\n        loadingMessage.textContent = message;\r\n    }\r\n    showLoading();\r\n}\r\n\r\nasync function checkSSO() {\r\n    enhancedLog(\"Checking SSO status...\", \"info\");\r\n    setLoadingState(\"Checking local cache...\");\r\n    \r\n    try {\r\n        // 1) Check local cache first\r\n        const cached = await oidc.getUser();\r\n        if (cached && !cached.expired) {\r\n            enhancedLog(\"Using cached user session\", \"success\");\r\n            updateAuthStatus(true, cached.profile);\r\n            return true;\r\n        }\r\n\r\n        // 2) Try silent signin (prompt=none)\r\n        setLoadingState(\"Checking SSO session...\");\r\n        const user = await oidc.signinSilent();\r\n        if (user && !user.expired) {\r\n            enhancedLog(\"Silent signin successful - SSO session active\", \"success\");\r\n            updateAuthStatus(true, user.profile);\r\n            return true;\r\n        }\r\n    } catch (error) {\r\n        enhancedLog(`SSO check failed: ${error.message}`, \"warn\");\r\n    }\r\n    \r\n    enhancedLog(\"No active SSO session found\", \"info\");\r\n    updateAuthStatus(false);\r\n    return false;\r\n}\r\n\r\nasync function bootstrapAuth() {\r\n    console.log(\"Bootstrapping auth...\");\r\n    state.isLoading.value = true;\r\n    try {\r\n        // init handlers\r\n        loginBtn.onclick = () => oidc.signinRedirect(); // sama dg kc.login()\r\n        switchBtn.onclick = () => {\r\n            const go = encodeURIComponent(\"/cpds/\");\r\n            window.location.href = `/cpds/#switcher`;     // sama seperti contohmu\r\n        };\r\n\r\n        // “check-sso” dulu\r\n        const ok = await checkSSO();\r\n        state.isAuthenticated.value = ok;\r\n\r\n        if (!ok) {\r\n            console.log(\"Not authenticated.\");\r\n            log(\"out\", \"Not authenticated.\");\r\n            // jika datang dengan hash #switcher → paksa login (login-required)\r\n            if (window.location.hash.includes(\"switcher\")) {\r\n                console.log(\"Switch detected, forcing login...\");\r\n                await oidc.signinRedirect();\r\n                return;\r\n            }\r\n        } else {\r\n            console.log(\"Authenticated.\");\r\n            log(\"out\", \"Authenticated.\");\r\n        }\r\n\r\n        // token lifecycle (mirip kc.updateToken)\r\n        oidc.events.addAccessTokenExpiring(async () => {\r\n            console.log(\"Access token expiring...\");\r\n            try {\r\n                await oidc.signinSilent(); log(\"out\", \"token expiring → silent renew\");\r\n                log(\"out\", \"silent renew success\");\r\n            } catch (error) {\r\n                log(\"out\", \"silent renew error: \" + error);\r\n            }\r\n        });\r\n        oidc.events.addAccessTokenExpired(async () => {\r\n            console.log(\"Access token expired\");\r\n            // coba renew; jika gagal, status jadi logged out\r\n            try {\r\n                await oidc.signinSilent(); \r\n                log(\"out\", \"token expired → silent renew\");\r\n            } catch (error) {\r\n                log(\"out\", \"silent renew error: \" + error);\r\n                state.isAuthenticated.value = false;\r\n            }\r\n        });\r\n        oidc.events.addUserSignedOut(async () => {\r\n            console.log(\"User signed out of SSO\");\r\n            // sesi di server berakhir\r\n            await oidc.removeUser();\r\n            state.isAuthenticated.value = false;\r\n        });\r\n\r\n    } catch (e) {\r\n        console.error(e);\r\n        log(\"out\", \"Init error: \" + e);\r\n        state.isAuthenticated.value = false;\r\n    } finally {\r\n        state.isLoading.value = false;\r\n    }\r\n}\r\n\r\neffect(() => {\r\n    // ui toggle - use consistent CSS classes\r\n    const authed = state.isAuthenticated.value;\r\n    if (authed) {\r\n        loginBtn.classList.add(\"hidden\");\r\n        logoutBtn.classList.remove(\"hidden\");\r\n        userInfoBtn.classList.remove(\"hidden\");\r\n        callApiBtn.classList.remove(\"hidden\");\r\n    } else {\r\n        loginBtn.classList.remove(\"hidden\");\r\n        logoutBtn.classList.add(\"hidden\");\r\n        userInfoBtn.classList.add(\"hidden\");\r\n        callApiBtn.classList.add(\"hidden\");\r\n    }\r\n\r\n    if (authed) {\r\n        if (!logoutBtn.onclick) {\r\n            logoutBtn.onclick = async () => {\r\n                try {\r\n                    await oidc.signoutRedirect({ post_logout_redirect_uri: `${window.location.origin}/aceas/` });\r\n                } finally {\r\n                    await oidc.removeUser(); // local cleanup\r\n                    state.isAuthenticated.value = false;\r\n                }\r\n            };\r\n        }\r\n\r\n        if (!userInfoBtn.onclick) {\r\n            userInfoBtn.onclick = async () => {\r\n                const u = await oidc.getUser();\r\n                if (!u) \r\n                    return log(\"out\", \"Not logged in!\");\r\n                const res = await fetch(\r\n                    \"http://eservice.localhost/auth/realms/agency-realm/protocol/openid-connect/userinfo\",\r\n                    { headers: { Authorization: `Bearer ${u.access_token}` } }\r\n                );\r\n                const info = await res.json();\r\n                state.userInfo.value = info;\r\n                log(\"out\", \"userinfo: \" + JSON.stringify(info, null, 2));\r\n\r\n                const ping = await fetch(\r\n                    \"http://eservice.localhost/auth/realms/agency-realm/demo/ping\",\r\n                    { headers: { Authorization: `Bearer ${u.access_token}` } }\r\n                );\r\n                log(\"out\", \"ping: \" + JSON.stringify(await ping.json(), null, 2));\r\n            };\r\n        }\r\n\r\n        if (!callApiBtn.onclick) {\r\n            callApiBtn.onclick = async () => {\r\n                const u = await oidc.getUser();\r\n                if (!u) \r\n                    return log(\"out\", \"Login first\");\r\n                const r = await callApi(\"/aceas/api/hello\", u.access_token);\r\n                log(\"out\", `ACEAS API [${r.status}]:\\n${r.body}`);\r\n            };\r\n        }\r\n    }\r\n});\r\n\r\neffect(() => state.isLoading.value ? showLoading() : hideLoading());\r\n\r\n// Add clear console event listener\r\nif (clearConsoleBtn) {\r\n    clearConsoleBtn.addEventListener('click', clearConsole);\r\n}\r\n\r\nbootstrapAuth();\r\n"],"names":["loginBtn","logoutBtn","userInfoBtn","callApiBtn","switchBtn","authStatus","clearConsoleBtn","state","signal","enhancedLog","message","type","styledMessage","log","clearConsole","consoleOutput","updateAuthStatus","isAuthenticated","userInfo","statusDot","statusText","setLoadingState","loadingMessage","showLoading","checkSSO","cached","oidc","user","error","bootstrapAuth","go","ok","effect","authed","u","info","ping","r","callApi","hideLoading"],"mappings":"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"}