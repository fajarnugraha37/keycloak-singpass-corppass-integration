{"version":3,"file":"index-FXqWltHZ-mgwgoinm.js","sources":["../../../web/src/pages/cpds.js"],"sourcesContent":["import 'htmx.org';\r\nimport './common.js';\r\nimport { callApi, log, showLoading, hideLoading } from \"../shared\";\r\n\r\nasync function authCheck() {\r\n    const r = await fetch(\"/ids/auth/refresh\", {\r\n        method: \"POST\",\r\n        credentials: \"include\"\r\n    });\r\n    if (!r.ok) {\r\n        window.localStorage.removeItem(\"access_token\");\r\n        window.localStorage.removeItem(\"refresh_token\");\r\n        window.localStorage.setItem(\"is_authenticated\", \"false\");\r\n\r\n        return false;\r\n    } else {\r\n        const { access_token, refresh_token } = await r.json();\r\n        window.localStorage.setItem(\"access_token\", access_token);\r\n        window.localStorage.setItem(\"refresh_token\", refresh_token);\r\n        window.localStorage.setItem(\"is_authenticated\", \"true\");\r\n\r\n        return true;\r\n    }\r\n}\r\nwindow.onload = async () => {\r\n    // ensure loading overlay is visible while we decide\r\n    showLoading();\r\n    let isNeedToHide = false;\r\n    try {\r\n        const isAuth = await authCheck();\r\n        if (!isAuth) {\r\n            log(\"out\", `State: not authenticated, please login`);\r\n            // Show login button when not authenticated\r\n            document.getElementById(\"login\").classList.remove(\"hidden\");\r\n            if (window.location.hash.includes(\"switcher\")) {\r\n                console.log(\"Switching\");\r\n                // keep overlay visible while redirecting\r\n                location.href = '/ids/auth/login';\r\n            } else {\r\n                isNeedToHide = true; // prevent hiding loading overlay\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        log(\"out\", `Authenticated.`);\r\n        \r\n        // Show authenticated buttons\r\n        document.getElementById(\"logout\").classList.remove(\"hidden\");\r\n        document.getElementById(\"userinfo\").classList.remove(\"hidden\");\r\n        document.getElementById(\"callapi\").classList.remove(\"hidden\");\r\n        \r\n        var interval = setInterval(async () => {\r\n            const isAuth = await authCheck();\r\n            if (!isAuth) {\r\n                log(\"out\", `State: not authenticated, clearing interval`);\r\n                clearInterval(interval);\r\n                // Hide authenticated buttons\r\n                document.getElementById(\"logout\").classList.add(\"hidden\");\r\n                document.getElementById(\"userinfo\").classList.add(\"hidden\");\r\n                document.getElementById(\"callapi\").classList.add(\"hidden\");\r\n                document.getElementById(\"login\").classList.remove(\"hidden\");\r\n                return;\r\n            }\r\n        }, 60000); // Check every minute \r\n        \r\n        isNeedToHide = true; // prevent hiding loading overlay\r\n    } catch (e) {\r\n        console.error(e);\r\n        log(\"out\", \"Init error: \" + e);\r\n    } finally {\r\n        // hide loading overlay after auth check\r\n        if (isNeedToHide) {\r\n            hideLoading();\r\n        }\r\n    }\r\n}\r\n\r\ndocument.getElementById(\"login\").onclick = () => {\r\n    // show loading while redirecting to login\r\n    showLoading();\r\n    location.href = '/ids/auth/login';\r\n};\r\ndocument.getElementById(\"logout\").onclick = () => {\r\n    showLoading();\r\n    location.href = '/ids/auth/logout';\r\n};\r\ndocument.getElementById(\"userinfo\").onclick = async () => {\r\n    const isAuthenticated = window.localStorage.getItem(\"is_authenticated\") === \"true\" && window.localStorage.getItem(\"access_token\");\r\n    if (!isAuthenticated) return log(\"out\", \"Not logged in\");\r\n\r\n    const res = await fetch('/ids/me', {\r\n        credentials: 'include',\r\n        headers: { Authorization: \"Bearer \" + window.localStorage.getItem(\"access_token\") }\r\n    });\r\n\r\n    log(\"out\", \"userinfo: \" + JSON.stringify(await res.json(), null, 2));\r\n};\r\ndocument.getElementById(\"callapi\").onclick = async () => {\r\n    const isAuthenticated = window.localStorage.getItem(\"is_authenticated\") === \"true\" && window.localStorage.getItem(\"access_token\");\r\n    if (!isAuthenticated) return log(\"out\", \"Not logged in\");\r\n    const r = await callApi(\"/cpds/api/hello\", window.localStorage.getItem(\"access_token\"));\r\n    log(\"out\", `CPDS API [${r.status}]:\\n${r.body}`);\r\n};\r\ndocument.getElementById(\"switch\").onclick = () => {\r\n    const go = encodeURIComponent(\"/aceas/\");\r\n    window.location.href = `/aceas/#switcher`;\r\n};\r\n\r\n// Clear console functionality\r\ndocument.getElementById(\"clear-console\")?.addEventListener('click', () => {\r\n    const consoleOutput = document.getElementById('out');\r\n    if (consoleOutput) {\r\n        consoleOutput.textContent = 'Console cleared.\\nWaiting for user interaction...';\r\n    }\r\n});"],"names":["authCheck","r","access_token","refresh_token","showLoading","isNeedToHide","log","interval","e","hideLoading","res","callApi","consoleOutput"],"mappings":"+MAIA,eAAeA,GAAY,CACvB,MAAMC,EAAI,MAAM,MAAM,oBAAqB,CACvC,OAAQ,OACR,YAAa,SACrB,CAAK,EACD,GAAKA,EAAE,GAMA,CACH,KAAM,CAAE,aAAAC,EAAc,cAAAC,CAAa,EAAK,MAAMF,EAAE,KAAI,EACpD,cAAO,aAAa,QAAQ,eAAgBC,CAAY,EACxD,OAAO,aAAa,QAAQ,gBAAiBC,CAAa,EAC1D,OAAO,aAAa,QAAQ,mBAAoB,MAAM,EAE/C,EACX,KAZI,eAAO,aAAa,WAAW,cAAc,EAC7C,OAAO,aAAa,WAAW,eAAe,EAC9C,OAAO,aAAa,QAAQ,mBAAoB,OAAO,EAEhD,EASf,CACA,OAAO,OAAS,SAAY,CAExBC,IACA,IAAIC,EAAe,GACnB,GAAI,CAEA,GAAI,CADW,MAAML,IACR,CACTM,EAAI,MAAO,wCAAwC,EAEnD,SAAS,eAAe,OAAO,EAAE,UAAU,OAAO,QAAQ,EACtD,OAAO,SAAS,KAAK,SAAS,UAAU,EAGxC,SAAS,KAAO,kBAEhBD,EAAe,GAGnB,MACJ,CAEAC,EAAI,MAAO,gBAAgB,EAG3B,SAAS,eAAe,QAAQ,EAAE,UAAU,OAAO,QAAQ,EAC3D,SAAS,eAAe,UAAU,EAAE,UAAU,OAAO,QAAQ,EAC7D,SAAS,eAAe,SAAS,EAAE,UAAU,OAAO,QAAQ,EAE5D,IAAIC,EAAW,YAAY,SAAY,CAEnC,GAAI,CADW,MAAMP,IACR,CACTM,EAAI,MAAO,6CAA6C,EACxD,cAAcC,CAAQ,EAEtB,SAAS,eAAe,QAAQ,EAAE,UAAU,IAAI,QAAQ,EACxD,SAAS,eAAe,UAAU,EAAE,UAAU,IAAI,QAAQ,EAC1D,SAAS,eAAe,SAAS,EAAE,UAAU,IAAI,QAAQ,EACzD,SAAS,eAAe,OAAO,EAAE,UAAU,OAAO,QAAQ,EAC1D,MACJ,CACJ,EAAG,GAAK,EAERF,EAAe,EACnB,OAASG,EAAG,CAERF,EAAI,MAAO,eAAiBE,CAAC,CACjC,QAAC,CAEOH,GACAI,GAER,CACJ,EAEA,SAAS,eAAe,OAAO,EAAE,QAAU,IAAM,CAE7CL,IACA,SAAS,KAAO,iBACpB,EACA,SAAS,eAAe,QAAQ,EAAE,QAAU,IAAM,CAC9CA,IACA,SAAS,KAAO,kBACpB,EACA,SAAS,eAAe,UAAU,EAAE,QAAU,SAAY,CAEtD,GAAI,EADoB,OAAO,aAAa,QAAQ,kBAAkB,IAAM,QAAU,OAAO,aAAa,QAAQ,cAAc,GAC1G,OAAOE,EAAI,MAAO,eAAe,EAEvD,MAAMI,EAAM,MAAM,MAAM,UAAW,CAC/B,YAAa,UACb,QAAS,CAAE,cAAe,UAAY,OAAO,aAAa,QAAQ,cAAc,CAAC,CACzF,CAAK,EAEDJ,EAAI,MAAO,aAAe,KAAK,UAAU,MAAMI,EAAI,KAAI,EAAI,KAAM,CAAC,CAAC,CACvE,EACA,SAAS,eAAe,SAAS,EAAE,QAAU,SAAY,CAErD,GAAI,EADoB,OAAO,aAAa,QAAQ,kBAAkB,IAAM,QAAU,OAAO,aAAa,QAAQ,cAAc,GAC1G,OAAOJ,EAAI,MAAO,eAAe,EACvD,MAAML,EAAI,MAAMU,EAAQ,kBAAmB,OAAO,aAAa,QAAQ,cAAc,CAAC,EACtFL,EAAI,MAAO,aAAaL,EAAE,MAAM;AAAA,EAAOA,EAAE,IAAI,EAAE,CACnD,EACA,SAAS,eAAe,QAAQ,EAAE,QAAU,IAAM,CAE9C,OAAO,SAAS,KAAO,kBAC3B,EAGA,SAAS,eAAe,eAAe,GAAG,iBAAiB,QAAS,IAAM,CACtE,MAAMW,EAAgB,SAAS,eAAe,KAAK,EAC/CA,IACAA,EAAc,YAAc;AAAA,iCAEpC,CAAC"}